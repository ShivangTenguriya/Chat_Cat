<!DOCTYPE html>
<html>
<head>
    <title>Chat Cat Server</title>
    <style>
body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f2f2f2;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    transition: background 0.3s;
}
body.dark { background: #121212; }

.chat-container {
    width: 400px;
    height: 600px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: background 0.3s;
}
body.dark .chat-container { background: #1e1e1e; }

.chat-header {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background-color: #1056a6;
    color: #fff;
    font-weight: bold;
    border-radius: 10px 10px 0 0;
    justify-content: space-between;
}
body.dark .chat-header { background: #1e1e1e; }

.chat-logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
    border: 2px solid #fff;
}
.chat-title { font-size: 18px; font-weight: bold; flex:1; }

.mode-btn {
    background: transparent;
    border: 1px solid #fff;
    border-radius: 5px;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    padding: 3px 6px;
}
.mode-btn:hover { background: rgba(255,255,255,0.2); }

.login-form {
    display: flex;
    flex-direction: column;
    padding: 20px;
    flex: 1;
}
.login-form input,
.login-form select {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
}
body.dark .login-form input,
body.dark .login-form select { background: #2a2a2a; color: #fff; border-color: #444; }
.login-form label { font-size: 12px; margin-bottom: 10px; }
.login-form button {
    padding: 10px;
    border: none;
    border-radius: 5px;
    background: #4b6cb7;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
}
.login-form button:hover { background: #182848; }

#partnerTyping {
    padding: 5px 15px;
    font-size: 12px;
    color: #555;
    min-height: 18px;
}
body.dark #partnerTyping { color: #ccc; }

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f9f9f9;
    display: none;
    flex-direction: column;
}
body.dark .chat-messages { background: #1e1e1e; }

.msg {
    margin-bottom: 4px;
    padding: 10px 14px;
    border-radius: 20px;
    max-width: 70%;
    word-wrap: break-word;
    font-size: 14px;
    line-height: 1.4;
    position: relative;
}

/* User messages (right) */
.msg.you {
    background: linear-gradient(135deg, #5b51d8, #833ab4, #e1306c);
    color: #fff;
    margin-left: auto;
    text-align: left;
    border-bottom-right-radius: 4px;
    border-bottom-left-radius: 20px;
}
.msg.you + .msg.you { border-top-right-radius: 6px; margin-top: 2px; }

/* Other messages (left) */
.msg.other {
    background: #efefef;
    color: #000;
    margin-right: auto;
    text-align: left;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 20px;
}
body.dark .msg.other { background: #2a2a2a; color: #fff; }
.msg.other + .msg.other { border-top-left-radius: 6px; margin-top: 2px; }

.reply-text {
    font-size: 12px;
    color: #f98f8f;
    background: rgba(0,0,0,0.05);
    padding: 5px 8px;
    border-left: 3px solid #999;
    margin-bottom: 5px;
    border-radius: 5px;
}

.chat-input {
    display: none;
    padding: 10px;
    background: #eee;
    border-top: 1px solid #ccc;
    flex-direction: row;
}
body.dark .chat-input { background: #1e1e1e; border-color: #333; }

.chat-input input {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
}
body.dark .chat-input input { background: #2a2a2a; color: #fff; border-color: #444; }

.chat-input button {
    margin-left: 10px;
    padding: 10px 15px;
    border: none;
    border-radius: 20px;
    background: #0095f6;
    color: #fff;
    cursor: pointer;
    font-weight: bold;
}
.chat-input button:hover { background: #0077cc; }
.skip-btn { background: #e74c3c !important; }
.skip-btn:hover { background: #c0392b !important; }

.chat-messages::-webkit-scrollbar { width: 6px; }
.chat-messages::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <img src="static/chat cat.png" class="chat-logo" alt="Logo">
        <span class="chat-title">Anonymous Chat</span>
        <button class="mode-btn" id="modeBtn">Dark Mode</button>
    </div>

    <!-- Partner typing text below header -->
    <div id="partnerTyping"></div>

    <form id="loginForm" class="login-form">
        <input id="nickname" placeholder="Nickname" required>
        <input id="age" type="number" placeholder="Age" min="18" required>
        <select id="gender" required>
            <option value="">Select Gender</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
        </select>
        <input id="mobile" placeholder="Mobile Number" required>
        <div style="margin-bottom:15px;">
            <input type="checkbox" id="agreeTerms">
            <label for="agreeTerms">I agree to <a href="{{ url_for('terms') }}">Terms & Conditions</a> and <a href="{{ url_for('privacy') }}">Privacy Policy</a></label>
        </div>
        <button type="submit">Start Chat</button>
    </form>

    <div id="messages" class="chat-messages"></div>

    <div id="chatInput" class="chat-input">
        <input id="text" placeholder="Type a message...">
        <button id="send">Send</button>
        <button id="skip" class="skip-btn">Skip</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
<script>
let socket;
let replyTo = null;
let typingTimeout;

const loginForm = document.getElementById("loginForm");
const header = document.querySelector(".chat-title");
const messages = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const modeBtn = document.getElementById("modeBtn");
const partnerTyping = document.getElementById("partnerTyping");

modeBtn.onclick = ()=>{
    document.body.classList.toggle("dark");
    modeBtn.innerText = document.body.classList.contains("dark") ? "Light Mode" : "Dark Mode";
};

function validMobile(num){ return /^[6-9][0-9]{9}$/.test(num); }

loginForm.onsubmit = async e => {
    e.preventDefault();
    const nickname = document.getElementById("nickname").value.trim();
    const age = parseInt(document.getElementById("age").value);
    const gender = document.getElementById("gender").value;
    const mobile = document.getElementById("mobile").value.trim();
    const agree = document.getElementById("agreeTerms").checked;
    if(age < 18){ alert("Age must be 18+"); return; }
    if(!validMobile(mobile)){ alert("Invalid mobile number"); return; }
    if(!nickname || !gender){ alert("All fields required"); return; }
    if(!agree){ alert("You must accept Terms & Privacy Policy"); return; }

    const res = await fetch("/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({nickname, age, gender, mobile})
    });
    const data = await res.json();
    if(!res.ok){ alert(data.error); return; }

    loginForm.style.display = "none";
    socket = io({ withCredentials:true });
    socket.on("connect", ()=> socket.emit("login"));
    socket.on("waiting", d => header.innerText = d.message);
    socket.on("chat_started", ()=>{
        header.innerText = "Chatting anonymously";
        chatInput.style.display = "flex";
        messages.style.display = "flex";
    });

    // Receive message
    socket.on("receiveMessage", d => {
        partnerTyping.innerText = ""; // hide typing
        addMessage("other", d.text, d.replyText);
    });

    // Partner typing
    socket.on("partner_typing", () => {
        partnerTyping.innerText = "Partner is typing...";
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => { partnerTyping.innerText = ""; }, 1500);
    });

    // Partner disconnected
    socket.on("partner_disconnected", d=>{
        partnerTyping.innerText = "";
        addMessage("other", d.message);
        chatInput.style.display="none";
    });
};

// Send message
document.getElementById("send").onclick = ()=>{
    const input = document.getElementById("text");
    const msg = input.value.trim();
    if(!msg) return; // prevent spaces-only
    addMessage("you", msg, replyTo);
    socket.emit("sendMessage",{text:msg,replyText:replyTo,timestamp:new Date().toLocaleTimeString()});
    input.value="";
    replyTo = null;
};

// Skip button
document.getElementById("skip").onclick = ()=>{
    socket.emit("skip_partner");
    chatInput.style.display="none";
};

// Emit typing event
document.getElementById("text").addEventListener("input", ()=>{
    if(socket) socket.emit("typing");
});

// Add message
function addMessage(type, text, reply){
    const div = document.createElement("div");
    div.className = "msg " + type;
    if(reply){
        const replyDiv = document.createElement("div");
        replyDiv.className = "reply-text";
        replyDiv.innerText = reply;
        div.appendChild(replyDiv);
    }
    const textNode = document.createTextNode(text);
    div.appendChild(textNode);
    if(type === "other"){ 
        div.onclick = () => { replyTo = text; alert("Replying to: " + text); }; 
    }
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}
</script>
</body>
</html>
